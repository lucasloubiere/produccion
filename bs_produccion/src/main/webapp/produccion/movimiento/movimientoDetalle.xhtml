<ui:composition
    xmlns="http://www.w3.org/1999/xhtml"
    xmlns:h="http://java.sun.com/jsf/html"
    xmlns:f="http://java.sun.com/jsf/core"
    xmlns:ui="http://java.sun.com/jsf/facelets"
    xmlns:p="http://primefaces.org/ui" >

    <!-- DETALLE -->
    <p:tabView id="tb" rendered="#{not empty movimientoProduccionBean.m and not movimientoProduccionBean.buscaMovimiento}">

        <p:tab title="Items"
               rendered="#{movimientoProduccionBean.m.tipoMovimiento eq 'OP' || movimientoProduccionBean.m.tipoMovimiento eq 'PP'}" >  

            <p:dataTable id="detalle" value="#{movimientoProduccionBean.m.itemsProducto}" var="i" 
                         resizeMode="expand" liveResize="true"
                         emptyMessage="No se encontraron items. Haga clic en agregar items"
                         rowStyleClass="#{i.conError  ? 'conError' : null}" >
                
                <f:facet name="footer">
                    <p:commandButton icon="fa fa-plus" value="Agregar item" 
                                     actionListener="#{movimientoProduccionBean.nuevoItemProducto()}"
                                     process="detalle" 
                                     update="detalle,message,messageg"                                     
                                     rendered="#{movimientoProduccionBean.circuito.permiteAgregarItems eq 'S'}"/>
                </f:facet>

                <p:column headerText="Código" width="70" 
                          rendered="#{movimientoProduccionBean.muestroCampo('D','ARTCOD')}"  >  

                    <h:outputText value="#{i.producto.codigo}" rendered="#{not empty i.producto}" />
                </p:column>

                <p:column headerText="Producto" width="300" >            
                    
                    <p:autoComplete value="#{i.producto}" completeMethod="#{productoBean.complete}" dropdown="true"
                                        var="p" itemLabel="#{p.descripcion}" itemValue="#{p}" converter="#{conversoresStock.producto}" forceSelection="true" >  
                        <p:ajax event="itemSelect" listener="#{movimientoProduccionBean.procesarProducto(i)}" update="detalle" />                             
                    </p:autoComplete>
                    
                    <!--
                    <p:commandButton icon="fa fa-search" process="@this"                                                                                          
                                     oncomplete="PF('dlgProducto').show()"  >
                        
                    </p:commandButton>

                    <h:outputText value="#{i.producto.descripcion}"                                   
                                  rendered="#{not empty i.producto}"/>
                    -->
                </p:column>
                
                <p:column headerText="Formula" width="100" >            
                    
                    <p:autoComplete value="#{i.formula}" completeMethod="#{formulaBean.complete}" dropdown="true"
                                    var="p" itemLabel="#{p.descripcion}" itemValue="#{p}" converter="#{conversoresStock.formula}" forceSelection="true" >                      
                        <p:ajax event="itemSelect" listener="#{movimientoProduccionBean.procesarComponentesYProcesos(i)}" update="tb" />                             
                    </p:autoComplete>
                    
                </p:column>

                <p:column headerText="Observaciones/Detalle" width="200" 
                          rendered="#{movimientoProduccionBean.muestroCampo('D','OBSERVA')}" >    
                    <p:inputTextarea value="#{i.observaciones}" rows="1"
                                     rendered="#{not empty i.producto}" /> 
                </p:column>

                <p:column headerText="Cantidad" width="70" rendered="#{movimientoProduccionBean.muestroCampo('D','CANTID')}" >                            

                    <p:inputText value="#{i.cantidad}" 
                                 rendered="#{not empty i.producto}" style="text-align: right;" >
                        <f:convertNumber pattern="###,###,##0.00"  />
                        <p:ajax listener="#{movimientoProduccionBean.actualizarCantidades(i)}" event="keyup" 
                                update="tb:detalleComponente"/>                                
                    </p:inputText>
                    
                </p:column>

                <p:column headerText="U.M." width="50" style="text-align: center;" 
                          rendered="#{movimientoProduccionBean.muestroCampo('D','UNIMED')}">                            
                    <h:outputText  value="#{i.unidadMedida.codigo}" rendered="#{not empty i.producto}" />
                </p:column>

                <!--
                
                <p:column headerText="Composición" width="60" styleClass="TexAlCenter" >
                    <p:rowToggler />
                </p:column>

                <p:rowExpansion>
                    <div class="Wid90 Fleft MarAuto WidAutoOnMobile">
                        <p:dataTable value="#{i.composicionFormula.itemsComponente}"  var="c" reflow="true"
                                     emptyMessage="No se encontraron datos">

                            <p:column headerText="Código" width="70">
                                <h:outputText value="#{c.productoComponente.codigo}"/>
                            </p:column>

                            <p:column headerText="Descripción" >
                                <h:outputText value="#{c.productoComponente.descripcion}"/>
                            </p:column>

                            <p:column headerText="Cantidad" width="70" >
                                <h:outputText value="#{c.cantidadNominal}" styleClass="Fright"  >                                    
                                    <f:convertNumber pattern="###,###,##0.00"  />                                    
                                </h:outputText>
                            </p:column>

                            <p:column headerText="U.M." width="50" style="text-align: center;">
                                <h:outputText value="#{c.unidadMedidaItem.codigo}"/>                                
                            </p:column>
                        </p:dataTable>                        

                    </div>

                </p:rowExpansion>
                -->

                <p:column headerText="" width="50" style="text-align: center;" >

                    <p:commandButton icon="fa fa-close" process="detalle" update="@form"
                                     actionListener="#{movimientoProduccionBean.eliminarItemProducto(i)}" >
                        <p:confirm header="Confirmación" message="Está seguro que desea borrar #{i.producto.descripcion}?" icon="ui-icon-alert" />
                    </p:commandButton>

                </p:column>

            </p:dataTable>

        </p:tab>

        <p:tab title="Componentes" 
               rendered="#{movimientoProduccionBean.m.tipoMovimiento eq 'OP' || movimientoProduccionBean.m.tipoMovimiento eq 'VC'}" >

            <p:dataTable id="detalleComponente" value="#{movimientoProduccionBean.m.itemsComponente}" var="i" 
                         resizeMode="expand" liveResize="true"
                         emptyMessage="No se encontraron items. Haga clic en agregar items"
                         rowStyleClass="#{i.conError  ? 'conError' : null}" >
                
                <f:facet name="footer">
                    <p:commandButton icon="fa fa-plus" value="Agregar item" 
                                     actionListener="#{movimientoProduccionBean.nuevoItemComponente()}"
                                     process="detalleComponente" 
                                     update="detalleComponente,message,messageg"                                     
                                     rendered="#{movimientoProduccionBean.circuito.permiteAgregarItems eq 'S'}"/>
                </f:facet>

                <p:column headerText="Código" width="70" >
                    <h:outputText value="#{i.producto.codigo}" />
                </p:column>
                <p:column headerText="Descripción" >
                    <h:outputText value="#{i.producto.descripcion}" />
                </p:column>

                <p:column headerText="Cantidad" width="70" rendered="#{movimientoProduccionBean.muestroCampo('D','CANTID')}" >                            

                    <p:inputText value="#{i.cantidad}" 
                                 rendered="#{not empty i.producto}" style="text-align: right;" >
                        <f:convertNumber pattern="###,###,##0.00"  />
                        <p:ajax listener="#{movimientoProduccionBean.actualizarCantidades(i)}" event="keyup" 
                                update="tb:detalleComponente"/>                                
                    </p:inputText>
                    
                </p:column>

                <p:column headerText="U.M." width="50" style="text-align: center;">
                    <h:outputText value="#{i.unidadMedida.codigo}" />
                </p:column>

                <p:commandButton icon="fa fa-close" process="detalleComponente" update="@form"
                                 actionListener="#{movimientoProduccionBean.eliminarItemComponente(i)}" 
                                 rendered="#{i.todoOk}" >
                    <p:confirm header="Confirmación" message="Está seguro que desea borrar #{i.producto.descripcion}?" icon="ui-icon-alert" />
                </p:commandButton>

            </p:dataTable>

        </p:tab>

        <p:tab title="Procesos" 
               rendered="#{movimientoProduccionBean.m.tipoMovimiento eq 'OP' || movimientoProduccionBean.m.tipoMovimiento eq 'PR'}" >

            <p:dataTable id="detalleProceso" value="#{movimientoProduccionBean.m.itemsProceso}" var="i" 
                         resizeMode="expand" liveResize="true"
                         emptyMessage="No se encontraron items. Haga clic en agregar items"
                         rowStyleClass="#{i.conError  ? 'conError' : null}" >
                
                <f:facet name="footer">
                    <p:commandButton icon="fa fa-plus" value="Agregar item" 
                                     actionListener="#{movimientoProduccionBean.nuevoItemProceso()}"
                                     process="detalleProceso" 
                                     update="detalleProceso,message,messageg"                                     
                                     rendered="#{movimientoProduccionBean.circuito.permiteAgregarItems eq 'S'}"/>
                </f:facet>

                <p:column headerText="Código" width="70" >  

                    <h:outputText value="#{i.producto.codigo}" rendered="#{not empty i.producto}" />
                </p:column>

                <p:column headerText="Proceso" width="300" >        
                    <h:outputText value="#{i.producto.descripcion}" rendered="#{not empty i.producto}"/>
                </p:column>

                <h:outputText value="Operario"   />
                <p:autoComplete value="#{i.operario}"    dropdown="true"                                        
                                completeMethod="#{operarioBean.complete}"
                                var="p" itemLabel="#{p.nombre}" itemValue="#{p}" 
                                converter="#{conversoresProduccion.operario}" forceSelection="true" >

                    <p:column>
                        <h:outputText value="#{p.codigo}" />
                    </p:column>

                    <p:column>
                        <h:outputText value="#{p.nombre}" />
                    </p:column>

                </p:autoComplete>

                <p:column headerText="Cantidad" width="70"  >                            

                    <!-- Item sin agregar -->
                    <p:inputText value="#{i.cantidad}" 
                                 rendered="#{not empty i.producto and not empty i.operario }" style="text-align: right;" >
                        <f:convertNumber pattern="###,###,##0.00"  />                        
                    </p:inputText>

                </p:column>

                <p:column headerText="U.M." width="50" style="text-align: center;" >                            
                    <h:outputText  value="#{i.unidadMedida.codigo}" rendered="#{not empty i.producto}" />
                </p:column>

                <p:column headerText="Observaciones/Detalle" width="200" >    
                    <p:inputTextarea value="#{i.observaciones}" rows="1"
                                     rendered="#{not empty i.producto and not empty i.operario}" /> 
                </p:column>

                <p:column headerText="" width="50" style="text-align: center;" >

                    <p:commandButton icon="fa fa-close" process="detalleProceso" update="@form"
                                     actionListener="#{movimientoProduccionBean.eliminarItemProceso(i)}" 
                                     rendered="#{i.todoOk}" >
                        <p:confirm header="Confirmación" message="Está seguro que desea borrar #{i.producto.descripcion}?" icon="ui-icon-alert" />
                    </p:commandButton>

                </p:column>

            </p:dataTable>

        </p:tab>

        <p:tab title="Operarios" 
               rendered="#{movimientoProduccionBean.m.tipoMovimiento eq 'OP' || movimientoProduccionBean.m.tipoMovimiento eq 'PH'}" >  

            <p:dataTable id="detalleHorario" value="#{movimientoProduccionBean.m.itemsHorario}" var="i" 
                         resizeMode="expand" liveResize="true"
                         emptyMessage="No se encontraron items. Haga clic en agregar items"
                         rowStyleClass="#{i.conError  ? 'conError' : null}" >
                
                <f:facet name="footer">
                    <p:commandButton icon="fa fa-plus" value="Agregar item" 
                                     actionListener="#{movimientoProduccionBean.nuevoItemHorario()}"
                                     process="detalleHorario" 
                                     update="detalleHorario,message,messageg"                                     
                                     rendered="#{movimientoProduccionBean.circuito.permiteAgregarItems eq 'S'}"/>
                </f:facet>

                <p:column headerText="Operario" width="200"  >                       
                    
                    <p:autoComplete value="#{i.operario}" dropdown="true"                                        
                                    completeMethod="#{operarioBean.complete}"
                                    var="p" itemLabel="#{p.nombre}" itemValue="#{p}" 
                                    converter="#{conversoresProduccion.operario}" forceSelection="true" >
                        
                        <p:ajax event="itemSelect" update="detalleHorario" />

                        <p:column>
                            <h:outputText value="#{p.codigo}" />
                        </p:column>

                        <p:column>
                            <h:outputText value="#{p.nombre}" />
                        </p:column>

                    </p:autoComplete> 
                    
                </p:column>

                <p:column headerText="Cantidad" width="70"  >                            

                    <p:inputText value="#{i.cantidad}" 
                                 rendered="#{not empty i.producto and not empty i.operario }" style="text-align: right;" >
                        <f:convertNumber pattern="###,###,##0.00"  />                        
                        <p:ajax event="change" process="@this" />
                    </p:inputText>

                </p:column>

                <p:column headerText="U.M." width="50" style="text-align: center;" >                            
                    <h:outputText  value="#{i.unidadMedida.codigo}" rendered="#{not empty i.producto}" />
                </p:column>

                <p:column headerText="Observaciones/Detalle" width="200" >    
                    <p:inputTextarea value="#{i.observaciones}" rows="1"
                                     rendered="#{not empty i.producto and not empty i.operario}" /> 
                </p:column>

                <p:column headerText="" width="50" style="text-align: center;" >

                    <p:commandButton icon="fa fa-close" process="detalleHorario" update="@form"
                                     actionListener="#{movimientoProduccionBean.eliminarItemHorario(i)}" >
                        <p:confirm header="Confirmación" message="Está seguro que desea borrar #{i.producto.descripcion}?" icon="ui-icon-alert" />
                    </p:commandButton>

                </p:column>

            </p:dataTable>

        </p:tab>

        <p:tab title="Aplicaciones" rendered="#{not empty movimientoProduccionBean.m.itemsAplicacion}" >  

            <p:dataTable id="detalleApl" value="#{movimientoProduccionBean.m.itemsAplicacion}"
                         var="i" resizeMode="expand" liveResize="true"
                         emptyMessage="No se encontraron datos" >

                <p:column headerText="Código" width="70" 
                          rendered="#{movimientoProduccionBean.muestroCampo('D','ARTCOD')}"  >  

                    <h:outputText value="#{i.producto.codigo}" rendered="#{not empty i.producto}" />
                </p:column>

                <p:column headerText="Producto" width="300" >                            
                    <h:outputText value="#{i.producto.descripcion}"                                   
                                  rendered="#{not empty i.producto}"/>
                </p:column>

                <p:column headerText="Cantidad" width="70" rendered="#{movimientoProduccionBean.muestroCampo('D','CANTID')}" > 
                    <h:outputText value="#{i.cantidad}"  styleClass="Fright"  >
                        <f:convertNumber pattern="###,###,##0.00"  />
                    </h:outputText>                           
                </p:column>

                <p:column headerText="U.M." width="50" style="text-align: center;" 
                          rendered="#{movimientoProduccionBean.muestroCampo('D','UNIMED')}">                            
                    <h:outputText  value="#{i.unidadMedida.codigo}" rendered="#{not empty i.producto}" />
                </p:column>

                <p:column headerText="Aplicación" width="70">                    
                    <h:outputText value="#{i.movimientoOriginal.formulario.codigo} - #{i.movimientoOriginal.numeroFormulario}"
                                  rendered="#{i.todoOk}"/>                    
                </p:column>


            </p:dataTable>

        </p:tab>

    </p:tabView>   


</ui:composition>

